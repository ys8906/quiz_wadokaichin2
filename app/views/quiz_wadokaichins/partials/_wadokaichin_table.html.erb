<div id="wadokaichin_table" class="row">
  <div class="wadokaichin__half-box col-12 col-md-6">
    <img class="wadokaichin__image" src="<%= @quiz.image_url %>">

    <div class="wadokaichin__button-box">
      <h5 class="text-warning text-center">
        <%= "以前解答した問題です" if @savedata.present? %>
      </h5>
      <div class="wadokaichin__button-box row justify-content-center">
        <h4 class="">答え</h4>
        <input class="ml-4" type="text" v-model="answer" placeholder="回答は1文字です。">
      </div>
      <div id="answer_buttons" class="wadokaichin__button-box row justify-content-center">
        <button
          class="wadokaichin__button-box--button btn btn-primary font-weight-bold col-5"
          @click="checkAnswer"
          :disabled="!answer || isCorrect || answerIsVisible"
        >
          解答する
        </button>
        <button
          class="wadokaichin__button-box--button btn btn-outline-dark ml-4 col-5"
          v-on:click="answerIsVisible = true"
          :disabled="answerIsVisible"
        >
          答えを見る
        </button>
      </div>

      <div class="wadokaichin__social-box">
        <div class="wadokaichin__button-box row justify-content-center">
          <div class="wadokaichin__button-box--button ml-n3 fb-like" data-href=<%= request.url %>
              　data-width="" data-layout="button" data-action="like" data-size="large"
              　data-share="false"></div>
          <span class="m-2"></span>
          <a href="https://twitter.com/share" class="twitter-share-button"
              data-text="あなたは解けるかな？"　data-url=<%= request.url %> data-show-count="false" data-size="large"></a>
        </div>

        <% if false %>
        <div class="wadokaichin__vote-box col-6 text-right">
          <div id="rating" class="rating">
            <h6>平均：<%= @reactions.present? ? (@reactions.average(:rating)+3)/(@reactions.size+1) : 3.0 %></h6>
            <% if @reactions.where(remote_ip: request.remote_ip).present? %>
              <span class="badge badge-primary">投票済み</span>
            <% else %>
              <%= form_with url: quiz_wadokaichin_reactions_path do |f| %>
                <%= f.hidden_field :quiz_id, value: @quiz.id %>
                <%= f.hidden_field :remote_ip, value: request.remote_ip %>
                <% 5.times.each do |i| %>
                  <label id="star-label-<%= i+1 %>" class="far fa-star fa-lg text-primary">
                    <input
                      type="radio"
                      name="rating"
                      class="d-none"
                      value="<%= i+1 %>"
                      v-model="star"
                      v-on:click="rate"
                    >
                  </label>
                <% end %>
                <%= f.submit "投票する", class: "btn btn-outline-dark" %>
              <% end %>
            <% end %>
          </div>          
        </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="wadokaichin__half-box col-12 col-md-6">
    <div class="mb-3">
      <h3
        v-if="isCorrect == true"
        class="text-success text-center"
      >
        正解！
      </h3>
      <h3
        v-else-if="isCorrect == false"
        class="text-warning text-center"
      >
        残念！
      </h3>
      <h3 v-else >ㅤ</h3>
    </div>

    <div class="wadokaichin__answer-box">
      <div
        v-if="answerIsVisible"
      >
        <h5>
          答え：
          <span class="wadokaichin__answer-box--large-letter"><%= @quiz.answer %></span>
        </h5>
        <h5>
          <br>
          <span class="wadokaichin__answer-box--large-letter">
            <%= @quiz.jukugo_right_name %>：
          </span>
          <br>
          <%= @quiz.jukugo_right.meaning %>
        </h5>
        <h5>
          <br>
          <span class="wadokaichin__answer-box--large-letter">
            <%= @quiz.jukugo_bottom_name %>：
          </span>
          <br>
          <%= @quiz.jukugo_bottom.meaning %>
        </h5>
        <h5>
          <br>
          <span class="wadokaichin__answer-box--large-letter">
            <%= @quiz.jukugo_left_name %>：
          </span>
          <br>
          <%= @quiz.jukugo_left.meaning %>
        </h5>
        <h5>
          <br>
          <span class="wadokaichin__answer-box--large-letter">
            <%= @quiz.jukugo_top_name %>：
          </span>
          <br>
          <%= @quiz.jukugo_top.meaning %>
        </h5>
      </div>
      <div
        v-else
      >
        <h5>
          <span class="wadokaichin__answer-box--large-letter text-primary">和</span>
          同開珎とは、四つの熟語に共通する、一つの漢字を当てるクイズです。<br>
          漢字を上下左右に四つ並べる様子が、日本最古の貨幣といわれる「和同開珎」に似ているため、
          しばしばなぞらえて同じ名前で呼ばれます。「虫食い漢字クイズ」などとも呼ばれます。
        </h5>
        <h5>
          <br>
          <span class="wadokaichin__answer-box--large-letter text-primary">画</span>
          像の中央に解答を入力し、「回答する」を押すと、解答結果が現れます。「答えを見る」を押すと、正答と解説が現れます。
        </h5>
      </div>
    </div>
    <%#= render 'quiz_wadokaichins/partials/form' %>
  </div>

</div>


<script>
new Vue ({
	el: '#wadokaichin_table',
	data: {
		answer: null,
		isCorrect: null,
    answerIsVisible: null,
    star: null,
	},
	watch: {
		answerIsVisible: function() {
			// もしユーザーかつセーブデータがなければ、正解するか答えを見たらセーブ
			if (<%= user_signed_in?.to_json.html_safe %> &&
							this.answerIsVisible && <%= @savedata.blank? %> == true) {
				axios.post('../../quiz_wadokaichin_savedata', {
					quiz_id: <%= @quiz.id %>,
					correct: this.isCorrect
				})
			}
		}
	},
	methods: {
		checkAnswer() {
			if (this.answer == <%= @quiz.answer.to_json.html_safe %>) {
				this.isCorrect = true
				this.answerIsVisible = true
			} else {
				this.isCorrect = false
			}
    },
		rate(e) {
			x = e.currentTarget.value
			for (let i = 1; i < 6; i++) {
				// "far fa-star": blank, "fas fa-star": filled
				document.getElementById(`star-label-${i}`).classList.remove("far", "fas")
				if (i <= x) {
					document.getElementById(`star-label-${i}`).classList.add("fas")
				} else {
					document.getElementById(`star-label-${i}`).classList.add("far")
				}
			}
		}    
	}
})
</script>